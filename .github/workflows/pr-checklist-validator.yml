name: PR Checklist Validator

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Validate PR Title (Conventional Commit style optional)
        run: |
          echo "PR Title: ${{ github.event.pull_request.title }}"
          if [[ ! "${{ github.event.pull_request.title }}" =~ ^(feat|fix|docs|refactor|test|chore)(\(.+\))?:\ .+ ]]; then
            echo "::warning title=Non-standard PR Title::Consider using conventional commit style (e.g., feat: add SOC 2 CC6.1 control mapping)"
          fi

      - name: Check for SOC 2 References in PR Body
        run: |
          echo "PR Body: ${{ github.event.pull_request.body }}" > pr_body.txt
          if ! grep -Eq 'CC[0-9]+\.[0-9]+' pr_body.txt; then
            echo "::error title=Missing SOC 2 Criteria::Please reference at least one SOC 2 criteria code (e.g., CC6.1)"
            exit 1
          fi

      - name: Check for PR Checklist Items
        run: |
          REQUIRED_ITEMS=("README.md updated" "Control implementation details are documented" "No secrets" "Tests pass")
          for item in "${REQUIRED_ITEMS[@]}"; do
            if ! grep -q "$item" pr_body.txt; then
              echo "::warning title=Missing Checklist Item::$item not confirmed in PR body"
            fi
          done

      - name: Lint Markdown Files
        uses: avto-dev/markdown-lint@v1
        with:
          config: '.markdownlint.yml'
        continue-on-error: true

      - name: Lint YAML Files
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yml
        continue-on-error: true
